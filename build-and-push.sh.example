#!/bin/bash

# Cloudflare Turnstile Goat Docker构建和推送脚本示例
# 复制此文件为 build-and-push.sh 并修改相应的配置

set -e  # 遇到错误立即退出

# 配置变量 - 请修改为你的实际配置
DOCKER_USERNAME="your-dockerhub-username"  # 修改为你的Docker Hub用户名
IMAGE_NAME="cloudflare-turnstile-goat"
IMAGE_TAG="latest"
FULL_IMAGE_NAME="${DOCKER_USERNAME}/${IMAGE_NAME}:${IMAGE_TAG}"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 检查本地环境
check_local_env() {
    log_info "检查本地环境..."
    
    if [ ! -f "Dockerfile" ]; then
        log_error "Dockerfile 文件不存在"
        exit 1
    fi
    
    if [ ! -d "frontend" ]; then
        log_error "frontend 目录不存在"
        exit 1
    fi
    
    if [ ! -d "backend" ]; then
        log_error "backend 目录不存在"
        exit 1
    fi
    
    # 检查Docker是否运行
    if ! docker info > /dev/null 2>&1; then
        log_error "Docker未运行，请启动Docker"
        exit 1
    fi
    
    log_info "本地环境检查通过"
}

# 检查Docker Hub用户名
check_docker_username() {
    if [ "$DOCKER_USERNAME" = "your-dockerhub-username" ]; then
        log_error "请修改脚本中的DOCKER_USERNAME为你的Docker Hub用户名"
        exit 1
    fi
}

# 构建Docker镜像
build_image() {
    log_info "构建Docker镜像: $FULL_IMAGE_NAME"
    
    docker build -t $FULL_IMAGE_NAME .
    
    log_info "Docker镜像构建完成"
}

# 测试镜像
test_image() {
    log_info "测试Docker镜像..."
    
    # 启动测试容器
    CONTAINER_ID=$(docker run -d -p 15269:52669 \
        -e FLASK_ENV=development \
        -e TURNSTILE_SITE_KEY=1x00000000000000000000AA \
        -e TURNSTILE_SECRET_KEY=1x0000000000000000000000000000000AA \
        $FULL_IMAGE_NAME)
    
    log_info "测试容器启动，ID: $CONTAINER_ID"
    
    # 等待容器启动
    sleep 10
    
    # 测试API
    if curl -f "http://localhost:15269/api/config" > /dev/null 2>&1; then
        log_info "镜像测试通过"
    else
        log_error "镜像测试失败"
        docker logs $CONTAINER_ID
        docker stop $CONTAINER_ID
        docker rm $CONTAINER_ID
        exit 1
    fi
    
    # 清理测试容器
    docker stop $CONTAINER_ID
    docker rm $CONTAINER_ID
    
    log_info "镜像测试完成"
}

# 登录Docker Hub
login_docker_hub() {
    log_info "登录Docker Hub..."
    
    if ! docker login; then
        log_error "Docker Hub登录失败"
        exit 1
    fi
    
    log_info "Docker Hub登录成功"
}

# 推送镜像
push_image() {
    log_info "推送镜像到Docker Hub: $FULL_IMAGE_NAME"
    
    docker push $FULL_IMAGE_NAME
    
    log_info "镜像推送完成"
}

# 显示部署信息
show_deployment_info() {
    log_info "构建和推送完成！"
    echo ""
    echo "镜像信息："
    echo "  镜像名称: $FULL_IMAGE_NAME"
    echo "  Docker Hub: https://hub.docker.com/r/${DOCKER_USERNAME}/${IMAGE_NAME}"
    echo ""
    echo "下一步："
    echo "  1. 修改 deploy-server.sh 中的 DOCKER_USERNAME"
    echo "  2. 运行 ./deploy-server.sh 进行服务器部署"
    echo ""
}

# 主函数
main() {
    log_info "开始构建和推送 Cloudflare Turnstile Goat Docker镜像..."
    
    check_local_env
    check_docker_username
    build_image
    test_image
    login_docker_hub
    push_image
    show_deployment_info
}

# 执行主函数
main "$@"
